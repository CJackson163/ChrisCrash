<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chris Crash</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #16213e;
            border-radius: 10px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #00d4ff;
        }

        .ai-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 5px;
        }

        .setup-section {
            background: #16213e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .setup-title {
            font-size: 16px;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 10px;
        }

        .setup-btn {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }

        .setup-btn:hover {
            background: #00b8d4;
        }

        .setup-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-indicator {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 10px;
            display: none;
        }

        .status-indicator.active {
            display: block;
        }

        .status-indicator.success {
            background: #27ae60;
        }

        .status-indicator.warning {
            background: #f39c12;
        }

        .status-indicator.error {
            background: #c70039;
        }

        .info-box {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 10px;
            line-height: 1.5;
        }

        .listen-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .listen-section.active {
            display: block;
        }

        .listen-btn {
            width: 100%;
            background: white;
            color: #667eea;
            border: none;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .listen-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(255,255,255,0.3);
        }

        .listen-btn.listening {
            background: #ff6b6b;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .heard-text {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            min-height: 50px;
            display: none;
        }

        .heard-text.active {
            display: block;
        }

        .heard-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .heard-content {
            font-size: 16px;
            line-height: 1.5;
        }

        .suggestions-section {
            background: #16213e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .suggestions-section.active {
            display: block;
        }

        .suggestions-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00d4ff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .loading-spinner {
            text-align: center;
            padding: 20px;
            font-size: 16px;
            color: #00d4ff;
        }

        .suggestion-btn {
            width: 100%;
            background: #0f4c75;
            color: white;
            border: 2px solid #00d4ff;
            padding: 18px;
            font-size: 17px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .suggestion-btn:hover {
            background: #1a5c8a;
            transform: translateX(5px);
        }

        .suggestion-btn:active {
            background: #00d4ff;
            color: #1a1a2e;
        }

        .controls {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
            background: #16213e;
            padding: 15px;
            border-radius: 10px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-size: 14px;
            min-width: 60px;
        }

        input[type="range"] {
            flex: 1;
            height: 30px;
        }

        .value-display {
            min-width: 40px;
            text-align: right;
            font-weight: bold;
            color: #00d4ff;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #00d4ff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button-grid {
            display: grid;
            gap: 12px;
        }

        .speak-btn {
            background: #0f4c75;
            color: white;
            border: 2px solid #00d4ff;
            padding: 20px;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            line-height: 1.4;
            min-height: 70px;
            display: flex;
            align-items: center;
        }

        .speak-btn:hover {
            background: #1a5c8a;
            transform: scale(1.02);
        }

        .speak-btn:active {
            background: #00d4ff;
            color: #1a1a2e;
        }

        .speak-btn.emergency {
            background: #dd7907;
            border-color: #ff6b9d;
            font-weight: bold;
        }

        .speak-btn.emergency:hover {
            background: #d97410;
        }

        .custom-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #00d4ff;
            border-radius: 8px;
            background: #0f4c75;
            color: white;
            margin-bottom: 10px;
        }

        .stop-btn {
            background: #c70039;
            color: white;
            border: 2px solid #ff6b9d;
            padding: 15px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .stop-btn:hover {
            background: #e01e5a;
        }

        .speaking-indicator {
            background: #00d4ff;
            color: #1a1a2e;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            display: none;
        }

        .speaking-indicator.active {
            display: block;
            animation: pulse 1.5s infinite;
        }

        .error-message {
            background: #c70039;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí¨ Chris Crash</h1>
        <p>AI-Powered Communication Assistant</p>
        <span class="ai-badge" id="aiBadge">ü§ñ AI: Not Connected</span>
    </div>

    <div class="setup-section" id="setupSection">
        <div class="setup-title">‚öôÔ∏è Setup Chrome AI</div>
        <button class="setup-btn" id="setupBtn">Initialize AI</button>
        <div class="status-indicator" id="statusIndicator"></div>
        <div class="info-box">
            <strong>Chrome Built-in AI:</strong> Free, runs on your device, completely private. No API key needed. Requires Chrome 127+ with AI features enabled.
            <br><br>
            <strong>To enable:</strong> Go to chrome://flags, enable "Prompt API for Gemini Nano" and "Optimization Guide On Device Model", then restart Chrome.
        </div>
    </div>

    <div class="speaking-indicator" id="indicator">üîä Speaking...</div>

    <div class="listen-section" id="listenSection">
        <button class="listen-btn" id="listenBtn">
            <span id="listenIcon">üëÇ</span>
            <span id="listenText">TAP TO LISTEN</span>
        </button>
        <div class="heard-text" id="heardText">
            <div class="heard-label">They said:</div>
            <div class="heard-content" id="heardContent"></div>
        </div>
        <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="suggestions-section" id="suggestionsSection">
        <div class="suggestions-title">üí° AI-Generated Responses (Tap to Speak)</div>
        <div id="suggestionsContainer"></div>
    </div>

    <button class="stop-btn" id="stopBtn">‚èπÔ∏è STOP SPEAKING</button>

    <div class="controls">
        <div class="control-group">
            <label for="rate">Speed:</label>
            <input type="range" id="rate" min="0.5" max="1.5" step="0.1" value="0.9">
            <span class="value-display" id="rateValue">0.9x</span>
        </div>
        <div class="control-group">
            <label for="volume">Volume:</label>
            <input type="range" id="volume" min="0" max="1" step="0.1" value="1">
            <span class="value-display" id="volumeValue">100%</span>
        </div>
    </div>

    <div class="section">
        <div class="section-title">‚ö†Ô∏è Important Messages</div>
        <div class="button-grid">
            <button class="speak-btn emergency" data-text="I have C F S, and I'm experiencing a severe crash. I cannot speak right now but I can hear you.">
                I have CFS/ME and I'm experiencing a severe crash. I cannot speak but I can hear you.
            </button>
            <button class="speak-btn emergency" data-text="Please speak slowly and wait for my responses. I need time to process.">
                Please speak slowly and wait for my responses
            </button>
            <button class="speak-btn emergency" data-text="I need quiet and rest.">
                I need quiet and rest
            </button>
        </div>
    </div>

    <div class="section">
        <div class="section-title">üÜò Basic Needs</div>
        <div class="button-grid">
            <button class="speak-btn" data-text="I need water please">
                I need water please
            </button>
            <button class="speak-btn" data-text="I need to lie down">
                I need to lie down
            </button>
        </div>
    </div>

    <div class="section">
        <div class="section-title">üí≠ Responses</div>
        <div class="button-grid">
            <button class="speak-btn" data-text="Yes">
                Yes
            </button>
            <button class="speak-btn" data-text="No">
                No
            </button>
            <button class="speak-btn" data-text="I don't know">
                I don't know
            </button>
        </div>
    </div>

    <div class="section">
        <div class="section-title">‚úèÔ∏è Custom Message</div>
        <input type="text" class="custom-input" id="customText" placeholder="Type your own message here...">
        <button class="speak-btn" id="customBtn">
            üó£Ô∏è Speak Custom Message
        </button>
    </div>

    <script>
        let currentUtterance = null;
        let recognition = null;
        let isListening = false;
        let aiSession = null;

        const rateSlider = document.getElementById('rate');
        const volumeSlider = document.getElementById('volume');
        const rateValue = document.getElementById('rateValue');
        const volumeValue = document.getElementById('volumeValue');
        const indicator = document.getElementById('indicator');
        const stopBtn = document.getElementById('stopBtn');
        const customText = document.getElementById('customText');
        const customBtn = document.getElementById('customBtn');
        const setupBtn = document.getElementById('setupBtn');
        const setupSection = document.getElementById('setupSection');
        const listenSection = document.getElementById('listenSection');
        const listenBtn = document.getElementById('listenBtn');
        const listenIcon = document.getElementById('listenIcon');
        const listenText = document.getElementById('listenText');
        const heardText = document.getElementById('heardText');
        const heardContent = document.getElementById('heardContent');
        const suggestionsSection = document.getElementById('suggestionsSection');
        const suggestionsContainer = document.getElementById('suggestionsContainer');
        const errorMessage = document.getElementById('errorMessage');
        const statusIndicator = document.getElementById('statusIndicator');
        const aiBadge = document.getElementById('aiBadge');

        // Setup AI button
        setupBtn.addEventListener('click', async () => {
            setupBtn.disabled = true;
            setupBtn.textContent = 'Initializing AI...';
            await initializeChromeAI();
            setupBtn.disabled = false;
            setupBtn.textContent = 'Initialize AI';
        });

        // Initialize Chrome's built-in AI
        async function initializeChromeAI() {
            if (!window.ai || !window.ai.languageModel) {
                showStatus('Chrome AI not available. Please enable AI features in Chrome flags.', 'error');
                return;
            }

            try {
                const capabilities = await window.ai.languageModel.capabilities();
                
                if (capabilities.available === 'no') {
                    showStatus('Chrome AI not available on this device', 'error');
                    return;
                }

                if (capabilities.available === 'after-download') {
                    showStatus('Downloading AI model... This may take a few minutes. Please wait.', 'warning');
                }

                aiSession = await window.ai.languageModel.create({
                    systemPrompt: `You are a compassionate communication assistant for someone with CFS/ME who is experiencing a severe crash and cannot speak. Your job is to suggest 4-5 SHORT, appropriate verbal responses (each 5-15 words) to what others say to them. 

Consider:
- The person has very limited energy
- They need clear, simple communication
- Responses should be polite but brief
- Include practical responses about their needs
- Be empathetic but direct

Format: Return ONLY a numbered list of responses, nothing else. Example:
1. Response here
2. Another response
3. Third response
4. Fourth response`
                });

                showStatus('Chrome AI ready! You can now use voice listening.', 'success');
                aiBadge.textContent = 'ü§ñ AI: Connected';
                setupSection.style.display = 'none';
                listenSection.classList.add('active');
                initRecognition();

            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Show status message
        function showStatus(message, type) {
            statusIndicator.textContent = message;
            statusIndicator.className = `status-indicator active ${type}`;
            setTimeout(() => {
                if (type !== 'success') {
                    statusIndicator.classList.remove('active');
                }
            }, 5000);
        }

        // Initialize speech recognition
        function initRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                errorMessage.textContent = 'Voice recognition not supported in this browser. Try Chrome or Safari.';
                errorMessage.classList.add('active');
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                listenBtn.classList.add('listening');
                listenIcon.textContent = 'üé§';
                listenText.textContent = 'LISTENING...';
                errorMessage.classList.remove('active');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                heardContent.textContent = transcript;
                heardText.classList.add('active');
                generateAISuggestions(transcript);
            };

            recognition.onerror = (event) => {
                console.error('Recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    errorMessage.textContent = 'Microphone access denied. Please allow microphone access in browser settings.';
                    errorMessage.classList.add('active');
                } else if (event.error === 'no-speech') {
                    errorMessage.textContent = 'No speech detected. Try again.';
                    errorMessage.classList.add('active');
                }
                resetListenButton();
            };

            recognition.onend = () => {
                resetListenButton();
            };
        }

        function resetListenButton() {
            isListening = false;
            listenBtn.classList.remove('listening');
            listenIcon.textContent = 'üëÇ';
            listenText.textContent = 'TAP TO LISTEN';
        }

        // Generate AI suggestions
        async function generateAISuggestions(heard) {
            suggestionsSection.classList.add('active');
            suggestionsContainer.innerHTML = '<div class="loading-spinner">ü§ñ AI is thinking...</div>';

            try {
                const prompt = `Someone just said to me: "${heard}"\n\nSuggest 4-5 brief responses (5-15 words each):`;
                const response = await aiSession.prompt(prompt);
                const suggestions = parseAIResponse(response);
                displaySuggestions(suggestions);
            } catch (error) {
                console.error('AI Error:', error);
                suggestionsContainer.innerHTML = '<div class="error-message active">Error generating responses. Try again.</div>';
            }
        }

        // Parse AI response into array
        function parseAIResponse(response) {
            const lines = response.split('\n').filter(line => line.trim());
            const suggestions = [];
            
            for (const line of lines) {
                // Remove numbering, bullets, etc.
                const cleaned = line.replace(/^\d+[\.\)]\s*/, '').replace(/^[-*]\s*/, '').trim();
                if (cleaned && cleaned.length > 3) {
                    suggestions.push(cleaned);
                }
            }
            
            return suggestions.slice(0, 5);
        }

        function displaySuggestions(suggestions) {
            suggestionsContainer.innerHTML = '';
            
            if (suggestions.length === 0) {
                suggestions = ['Thank you', 'Yes', 'No', 'Please wait'];
            }

            suggestions.forEach(suggestion => {
                const btn = document.createElement('button');
                btn.className = 'suggestion-btn';
                btn.textContent = suggestion;
                btn.onclick = () => speak(suggestion);
                suggestionsContainer.appendChild(btn);
            });
        }

        // Listen button
        listenBtn.addEventListener('click', () => {
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        // Update slider displays
        rateSlider.addEventListener('input', (e) => {
            rateValue.textContent = e.target.value + 'x';
        });

        volumeSlider.addEventListener('input', (e) => {
            volumeValue.textContent = Math.round(e.target.value * 100) + '%';
        });

        // Speech function
        function speak(text) {
            // Cancel any ongoing speech
            window.speechSynthesis.cancel();

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.rate = parseFloat(rateSlider.value);
            currentUtterance.volume = parseFloat(volumeSlider.value);
            currentUtterance.pitch = 1;

            currentUtterance.onstart = () => {
                indicator.classList.add('active');
            };

            currentUtterance.onend = () => {
                indicator.classList.remove('active');
            };

            currentUtterance.onerror = () => {
                indicator.classList.remove('active');
            };

            window.speechSynthesis.speak(currentUtterance);
        }

        // Add click handlers to all speak buttons
        document.querySelectorAll('.speak-btn[data-text]').forEach(btn => {
            btn.addEventListener('click', () => {
                const text = btn.getAttribute('data-text');
                speak(text);
            });
        });

        // Custom message button
        customBtn.addEventListener('click', () => {
            const text = customText.value.trim();
            if (text) {
                speak(text);
            }
        });

        // Allow Enter key to speak custom message
        customText.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const text = customText.value.trim();
                if (text) {
                    speak(text);
                }
            }
        });

        // Stop button
        stopBtn.addEventListener('click', () => {
            window.speechSynthesis.cancel();
            indicator.classList.remove('active');
            if (recognition && isListening) {
                recognition.stop();
            }
        });
    </script>
</body>
</html>